<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.oa_system_backend.module.asset.mapper.AssetMapper">

    <!-- 结果映射 -->
    <resultMap id="AssetVOMap" type="com.example.oa_system_backend.module.asset.vo.AssetVO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="category" column="category"/>
        <result property="categoryName" column="categoryName"/>
        <result property="brandModel" column="brand_model"/>
        <result property="purchaseDate" column="purchase_date"/>
        <result property="purchasePrice" column="purchase_price"/>
        <result property="currentValue" column="current_value"/>
        <result property="status" column="status"/>
        <result property="statusName" column="statusName"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userAvatar" column="user_avatar"/>
        <result property="images" column="images" typeHandler="com.example.oa_system_backend.common.handler.JsonListTypeHandler"/>
        <result property="location" column="location"/>
        <result property="borrowDate" column="borrow_date"/>
        <result property="expectedReturnDate" column="expected_return_date"/>
        <result property="createdAt" column="created_at"/>
        <result property="isOverdue" column="is_overdue"/>
        <result property="version" column="version"/>
    </resultMap>

    <!-- 分页查询资产视图对象 -->
    <select id="selectPageWithDetails" resultMap="AssetVOMap">
        SELECT
            a.id,
            a.name,
            a.category,
            CASE a.category
                WHEN 'electronic' THEN '电子设备'
                WHEN 'furniture' THEN '家具'
                WHEN 'book' THEN '图书'
                WHEN 'other' THEN '其他'
            END AS categoryName,
            a.brand_model,
            a.purchase_date,
            a.purchase_price,
            a.current_value,
            a.status,
            CASE a.status
                WHEN 'stock' THEN '在库'
                WHEN 'in_use' THEN '使用中'
                WHEN 'borrowed' THEN '借出'
                WHEN 'maintenance' THEN '维护中'
                WHEN 'scrapped' THEN '报废'
            END AS statusName,
            a.user_id,
            e.name AS user_name,
            e.avatar AS user_avatar,
            a.images,
            a.location,
            a.borrow_date,
            a.expected_return_date,
            a.created_at,
            a.version,
            CASE
                WHEN a.status = 'borrowed' AND a.expected_return_date &lt; CURDATE() THEN 1
                ELSE 0
            END AS is_overdue
        FROM biz_asset a
        LEFT JOIN sys_employee e ON a.user_id = e.id
        WHERE a.is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (
                a.name LIKE CONCAT('%', #{keyword}, '%')
                OR a.id LIKE CONCAT('%', #{keyword}, '%')
                OR a.brand_model LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="category != null and category != ''">
            AND a.category = #{category}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        <if test="userId != null and userId != ''">
            AND a.user_id = #{userId}
        </if>
        <if test="purchaseDateStart != null and purchaseDateStart != ''">
            AND a.purchase_date &gt;= #{purchaseDateStart}
        </if>
        <if test="purchaseDateEnd != null and purchaseDateEnd != ''">
            AND a.purchase_date &lt;= #{purchaseDateEnd}
        </if>
        <if test="purchasePriceMin != null">
            AND a.purchase_price &gt;= #{purchasePriceMin}
        </if>
        <if test="purchasePriceMax != null">
            AND a.purchase_price &lt;= #{purchasePriceMax}
        </if>
        <if test="location != null and location != ''">
            AND a.location LIKE CONCAT('%', #{location}, '%')
        </if>
        <if test="sortOrder != null and sortOrder == 'asc'">
            ORDER BY a.created_at ASC
        </if>
        <if test="sortOrder == null or sortOrder != 'asc'">
            ORDER BY a.created_at DESC
        </if>
    </select>

</mapper>
