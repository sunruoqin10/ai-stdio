<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.oa_system_backend.module.leave.mapper.LeaveApprovalMapper">

    <resultMap id="BaseResultMap" type="com.example.oa_system_backend.module.leave.entity.LeaveApproval">
        <id column="id" property="id"/>
        <result column="request_id" property="requestId"/>
        <result column="approver_id" property="approverId"/>
        <result column="approver_name" property="approverName"/>
        <result column="approval_level" property="approvalLevel"/>
        <result column="status" property="status"/>
        <result column="opinion" property="opinion"/>
        <result column="timestamp" property="timestamp"/>
    </resultMap>

    <resultMap id="ApprovalWithInfoMap" type="com.example.oa_system_backend.module.leave.vo.ApprovalRecordVO"
               extends="BaseResultMap">
        <result column="approver_position" property="approverPosition"/>
        <result column="approver_avatar" property="approverAvatar"/>
        <result column="approver_department" property="approverDepartment"/>
    </resultMap>

    <select id="selectByRequestId" resultMap="BaseResultMap">
        SELECT a.*
        FROM approval_leave_approval a
        WHERE a.request_id = #{requestId}
        ORDER BY a.approval_level ASC
    </select>

    <select id="selectPendingByApproverId" resultMap="ApprovalWithInfoMap">
        SELECT
            a.*,
            e.position AS approver_position,
            e.avatar AS approver_avatar,
            d.name AS approver_department
        FROM approval_leave_approval a
        LEFT JOIN sys_employee e ON a.approver_id = e.id
        LEFT JOIN sys_department d ON e.department_id = d.id
        WHERE a.approver_id = #{approverId}
          AND a.status = 'pending'
        ORDER BY a.timestamp ASC
    </select>

    <select id="countByRequestIdAndLevel" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM approval_leave_approval
        WHERE request_id = #{requestId}
          AND approval_level = #{approvalLevel}
    </select>

    <select id="countApprovedByRequestId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM approval_leave_approval
        WHERE request_id = #{requestId}
          AND status = 'approved'
    </select>

    <select id="countRejectedByRequestId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM approval_leave_approval
        WHERE request_id = #{requestId}
          AND status = 'rejected'
    </select>

</mapper>
