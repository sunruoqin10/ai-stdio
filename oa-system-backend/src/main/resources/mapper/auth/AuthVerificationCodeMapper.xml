<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.oa_system_backend.module.auth.mapper.AuthVerificationCodeMapper">

    <select id="countRecentCodesByAccount" resultType="int">
        SELECT COUNT(*) FROM auth_verification_code
        WHERE account = #{account}
          AND created_at > DATE_SUB(NOW(), INTERVAL #{minutes} MINUTE)
    </select>

    <select id="selectValidCode" resultType="com.example.oa_system_backend.module.auth.entity.AuthVerificationCode">
        SELECT * FROM auth_verification_code
        WHERE account = #{account}
          AND code = #{code}
          AND scene = #{scene}
          AND is_used = 0
          AND expires_at > NOW()
        ORDER BY created_at DESC
        LIMIT 1
    </select>

</mapper>
