# 功能测试计划 - 报销单"已完成"状态

**测试日期**: 2026-01-24
**测试环境**: 待定
**测试人员**: 待定

---

## 测试前准备

### 环境要求
- [ ] 后端服务已启动（包含最新的代码变更）
- [ ] 前端服务已启动（包含最新的构建）
- [ ] 数据库已更新（包含 completed 状态）
- [ ] 测试用户账号已准备（需要财务权限）

### 测试数据准备
- [ ] 创建测试报销单（状态：草稿）
- [ ] 提交审批流程
- [ ] 完成部门审批
- [ ] 完成财务审批（状态变为"待打款"）

---

## 测试用例

### TC-01: 完整报销流程测试
**优先级**: P0 (必须)

**测试步骤**:
1. 登录系统
2. 进入"费用报销" → "我的报销"
3. 点击"新建报销"按钮
4. 填写报销单信息：
   - 报销类型：差旅费
   - 费用明细：添加交通费用 500 元
   - 上传发票图片
   - 填写说明
5. 点击"提交"按钮
6. 观察状态变化：草稿 → 待部门审批
7. 切换到部门主管账号，审批通过
8. 观察状态变化：待部门审批 → 待财务审批
9. 切换到财务人员账号，审批通过
10. 观察状态变化：待财务审批 → **待打款**

**预期结果**:
- ✅ 报销单创建成功
- ✅ 审批流程正常流转
- ✅ 状态正确变化
- ✅ 最终状态显示为"待打款"

---

### TC-02: 上传凭证功能测试
**优先级**: P0 (必须)

**前置条件**:
- 报销单状态为"待打款"
- 已准备好打款凭证图片

**测试步骤**:
1. 登录系统（财务账号）
2. 进入"费用报销" → "打款管理"
3. 找到待打款的报销单
4. 点击"上传凭证"按钮
5. 在上传对话框中：
   - 选择凭证图片（JPG/PNG）
   - 预览图片应立即显示（本地预览）
   - 输入备注信息（可选）
6. 点击"确认上传"按钮

**预期结果**:
- ✅ 图片立即显示预览（无网络延迟）
- ✅ 点击"确认上传"后才上传
- ✅ 显示"凭证上传成功"提示
- ✅ 对话框自动关闭
- ✅ 列表刷新

---

### TC-03: 状态自动更新为"已完成"测试
**优先级**: P0 (必须)

**测试步骤**:
1. 继续 TC-02 的操作
2. 上传凭证成功后
3. 查看"我的报销"页面
4. 找到该报销单，观察状态
5. 刷新页面，再次确认状态

**预期结果**:
- ✅ 状态从"待打款"变为"已完成"
- ✅ 状态标签显示为绿色（success）
- ✅ 状态文本显示"已完成"
- ✅ 刷新后状态保持不变

---

### TC-04: "我的报销"页面显示测试
**优先级**: P1 (重要)

**测试步骤**:
1. 进入"费用报销" → "我的报销"
2. 查看已完成状态的报销单
3. 检查状态列
4. 检查状态标签颜色
5. 检查状态标签文本
6. 将鼠标悬停在状态标签上，查看提示信息

**预期结果**:
- ✅ 状态列显示"已完成"
- ✅ 状态标签为绿色（#67C23A）
- ✅ 悬停提示："报销流程已完成，打款凭证已上传"
- ✅ 可以看到"查看凭证"按钮

---

### TC-05: "打款管理"页面显示测试
**优先级**: P1 (重要)

**测试步骤**:
1. 进入"费用报销" → "打款管理"
2. 查看已完成的打款记录
3. 检查状态列
4. 检查操作按钮

**预期结果**:
- ✅ 打款记录状态显示"已完成"
- ✅ 状态标签为绿色
- ✅ "上传凭证"按钮不可见（已上传）
- ✅ 显示"查看凭证"按钮

---

### TC-06: 状态颜色和标签验证
**优先级**: P1 (重要)

**测试步骤**:
1. 对比所有状态的标签颜色
2. 验证"已完成"状态的样式
3. 在不同浏览器中测试显示

**预期结果**:
- ✅ 草稿：灰色/信息色
- ✅ 待部门审批：橙色/警告色
- ✅ 待财务审批：蓝色/主色
- ✅ 待打款：绿色/成功色
- ✅ **已完成：绿色/成功色** ✨
- ✅ 已拒绝：红色/危险色

---

### TC-07: 历史数据不受影响测试
**优先级**: P2 (重要)

**测试步骤**:
1. 查询数据库中状态为"待打款"的旧报销单
2. 不对这些旧单据进行任何操作
3. 重启后端服务
4. 刷新前端页面
5. 查看旧报销单的状态

**预期结果**:
- ✅ 旧报销单状态保持为"待打款"
- ✅ 不会自动变为"已完成"
- ✅ 可以为旧报销单上传凭证
- ✅ 上传凭证后状态变为"已完成"

---

### TC-08: 数据库状态验证
**优先级**: P0 (必须)

**测试步骤**:
1. 上传凭证成功后
2. 查询数据库表 `expense`
3. 查找该报销单记录
4. 检查以下字段：
   - `status` 字段
   - `payment_proof` 字段
   - `updated_at` 字段

**SQL验证查询**:
```sql
SELECT id, expense_id, status, payment_proof, updated_at
FROM expense
WHERE expense_id = 'EXP202601240001';
```

**预期结果**:
- ✅ `status` = 'completed'
- ✅ `payment_proof` 包含凭证URL
- ✅ `updated_at` 是最新时间

---

### TC-09: API 响应验证
**优先级**: P1 (重要)

**测试步骤**:
1. 打开浏览器开发者工具
2. 进入"打款管理"页面
3. 上传凭证
4. 在 Network 标签中查看 API 请求
5. 验证请求和响应

**API 端点**: `POST /expense/{expenseId}/payment-proof`

**预期结果**:
- ✅ 请求参数：`proofUrl` 包含图片URL
- ✅ 响应状态：200 OK
- ✅ 响应体：`{ "code": 200, "message": "success" }`

---

## 测试检查清单

### 功能验证
- [ ] 完整流程测试通过
- [ ] 上传凭证功能正常
- [ ] 状态自动更新为"已完成"
- [ ] 页面显示正确

### 数据验证
- [ ] 数据库状态正确
- [ ] API 响应正确
- [ ] 历史数据不受影响

### UI/UX 验证
- [ ] 状态标签颜色正确
- [ ] 状态提示信息正确
- [ ] 页面交互流畅

### 兼容性验证
- [ ] Chrome 浏览器测试通过
- [ ] Firefox 浏览器测试通过
- [ ] Edge 浏览器测试通过

---

## 测试结果记录

### 测试执行人: ___________
### 测试日期: ___________

| 用例编号 | 测试项 | 状态 | 备注 |
|---------|-------|------|------|
| TC-01 | 完整报销流程 | [ ] | |
| TC-02 | 上传凭证功能 | [ ] | |
| TC-03 | 状态自动更新 | [ ] | |
| TC-04 | 我的报销页面 | [ ] | |
| TC-05 | 打款管理页面 | [ ] | |
| TC-06 | 状态颜色标签 | [ ] | |
| TC-07 | 历史数据 | [ ] | |
| TC-08 | 数据库验证 | [ ] | |
| TC-09 | API响应 | [ ] | |

---

## 问题记录

### 发现的问题

| 编号 | 问题描述 | 严重程度 | 状态 | 备注 |
|------|---------|---------|------|------|
| | | | | |

### 测试建议

1. **测试环境**: 建议先在测试环境验证，确认无误后再部署到生产环境
2. **数据备份**: 测试前务必备份数据库
3. **回滚准备**: 准备回滚方案，以防测试失败影响生产
4. **用户通知**: 测试期间通知用户，避免影响正常业务

---

**测试完成标准**:
- ✅ 所有 P0 优先级用例通过
- ✅ 无阻塞性缺陷
- ✅ 状态流转完全正确
- ✅ 用户体验良好

---

**文档版本**: 1.0
**最后更新**: 2026-01-24
